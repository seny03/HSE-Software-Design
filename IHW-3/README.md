# Отчет по контрольной работе №3

## 1. Архитектура приложения

### Структура системы

Приложение построено на архитектуре микросервисов и включает в себя три основных сервиса:

1. **API Gateway** — маршрутизирует запросы клиентов и предоставляет единую точку входа в систему.
2. **Orders Service** — отвечает за создание заказов, просмотр списка заказов и просмотр статуса заказа.
3. **Payments Service** — отвечает за создание счетов, пополнение и просмотр баланса счета.

Взаимодействие между сервисами происходит как синхронно через REST API, так и асинхронно через очереди сообщений (Kafka). Все сервисы контейнеризованы с помощью Docker и управляются через Docker Compose.

### Схема взаимодействия сервисов

Последовательность действий при создании заказа:
1. Клиент отправляет запрос на создание заказа через API Gateway
2. Orders Service создает заказ в статусе "Created" и отправляет сообщение в очередь
3. Payments Service получает сообщение, проверяет достаточность средств и списывает деньги
4. Payments Service отправляет сообщение о результате оплаты
5. Orders Service обновляет статус заказа ("Paid" или "Failed")

## 2. Описание функциональности

### Основные функции

#### Payments Service
- **Создание счета**: создание счета для пользователя (не более одного счета на пользователя)
- **Пополнение счета**: увеличение баланса счета пользователя
- **Просмотр баланса**: получение текущего баланса счета пользователя

#### Orders Service
- **Создание заказа**: создание заказа с асинхронным запуском процесса оплаты
- **Просмотр списка заказов**: получение списка заказов пользователя
- **Просмотр статуса заказа**: получение информации о конкретном заказе

### Эндпоинты сервисов

#### API Gateway

- `GET /health` — состояние всех сервисов
- `GET /products` — получение списка доступных продуктов
- `GET /products/{id}` — получение информации о конкретном продукте
- `GET /orders` — получение списка заказов пользователя
- `POST /orders` — создание нового заказа
- `GET /orders/{id}` — получение информации о конкретном заказе
- `POST /payments/accounts` — создание счета пользователя
- `POST /payments/accounts/{userId}/deposit` — пополнение счета пользователя
- `GET /payments/accounts/{userId}/balance` — получение баланса счета пользователя
- `GET /payments/accounts` — получение списка всех счетов

#### Orders Service

- `GET /health` — проверка статуса сервиса
- `POST /orders` — создание заказа
- `GET /orders` — получение списка заказов пользователя
- `GET /orders/{id}` — получение информации о заказе
- `GET /products` — получение списка продуктов
- `GET /products/{id}` — получение информации о продукте

#### Payments Service

- `GET /health` — проверка статуса сервиса
- `POST /accounts` — создание счета
- `POST /accounts/{userId}/deposit` — пополнение счета
- `GET /accounts/{userId}/balance` — получение баланса счета
- `GET /accounts` — получение списка всех счетов
- `GET /transactions` — получение истории транзакций

## 3. Используемые технологии

- **ASP.NET Core 8.0** — backend-фреймворк
- **Entity Framework Core** — ORM для работы с базами данных
- **PostgreSQL** — база данных для хранения информации о заказах и счетах
- **Apache Kafka** — система обмена сообщениями для асинхронного взаимодействия
- **Docker/Docker Compose** — контейнеризация сервисов
- **Swagger** — документация API и ручное тестирование
- **xUnit, Moq** — тестирование
- **Blazor WebAssembly** — фронтенд-часть приложения

## 4. Архитектурные паттерны

- **Transactional Outbox** — в Orders Service для надежной отправки сообщений
- **Transactional Inbox и Outbox** — в Payments Service для обеспечения надежности обработки сообщений
- **Exactly Once семантика** — при списании денег у пользователя для предотвращения двойного списания

## 5. Запуск приложения

```bash
docker-compose up --build
```

Веб-интерфейс: http://localhost:5001

Адреса API:
 - API Gateway: http://localhost:5000
 - Payments Service: http://localhost:5002
 - Orders Service: http://localhost:5003

## 6. Тестирование

Проект покрыт unit-тестами с помощью xUnit и Moq. Для запуска всех тестов и генерации отчета о покрытии используйте:

```bash
# Linux/Mac
./run-tests.sh

# Windows
./run-tests.bat
```

Отчет о покрытии кода тестами можно посмотреть в `test-results/coveragereport/index.html`.

### Тестирование API

Адреса swagger для каждого из API:
 - API Gateway: http://localhost:5000/swagger
 - Payments Service: http://localhost:5002/swagger
 - Orders Service: http://localhost:5003/swagger
